name: sync to blog.space

on:
  push:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write        # åˆ›å»º issue çš„æƒé™
      pull-requests: write # åˆ›å»º PR çš„æƒé™

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Step 1: æ£€å‡ºå†…å®¹ä»“åº“
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout content repo
        uses: actions/checkout@v4
        with:
          path: content  # æ£€å‡ºåˆ° ./content ç›®å½•

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Step 2: æ£€å‡ºç›®æ ‡åšå®¢ä»“åº“
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout blog repo
        uses: actions/checkout@v4
        with:
          repository: s7ev3n/blog.space  # ç›®æ ‡ä»“åº“
          path: blog                      # æ£€å‡ºåˆ° ./blog ç›®å½•
          token: ${{ secrets.BLOG_SYNC_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Step 3: æäº¤å¹¶æ¨é€åˆ°æ–°åˆ†æ”¯
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push to new branch
        id: commit-push
        run: |
          cd blog

          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # é…ç½® remote ä½¿ç”¨ PAT
          git remote set-url origin https://x-access-token:${{ secrets.BLOG_SYNC_TOKEN }}@github.com/s7ev3n/blog.space.git

          # åˆ›å»ºå”¯ä¸€çš„åˆ†æ”¯å
          BRANCH="content/til-sync-$(date +%s)"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # å…ˆåˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯ï¼ˆåœ¨ rsync ä¹‹å‰çš„çŠ¶æ€ï¼‰
          git checkout -b "$BRANCH"

          # ç°åœ¨ rsync ä¼šåœ¨è¿™ä¸ªæ–°åˆ†æ”¯ä¸Šäº§ç”Ÿå˜æ›´
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.scripts' \
            --exclude='LICENSE' \
            ../content/ src/content/post/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          git add src/content/post

          # åªæœ‰æœ‰å˜æ›´æ—¶æ‰ commit å’Œ push
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Sync content from til@$(cd ../content && git rev-parse --short HEAD)"
            git push origin "$BRANCH"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Step 4: è‡ªåŠ¨åˆ›å»º PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Pull Request
        if: steps.commit-push.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.commit-push.outputs.branch }}';

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¥è‡ª content/* åˆ†æ”¯çš„ PR
            const { data: pulls } = await github.rest.pulls.list({
              owner: 's7ev3n',
              repo: 'blog.space',
              state: 'open',
              head: 's7ev3n:' + branch
            });

            // å¦‚æœæ²¡æœ‰ PRï¼Œåˆ™åˆ›å»º
            if (pulls.length === 0) {
              const { data: pr } = await github.rest.pulls.create({
                owner: 's7ev3n',
                repo: 'blog.space',
                title: 'ğŸ“ è‡ªåŠ¨åŒæ­¥åšå®¢å†…å®¹',
                body: `ç”± [til](https://github.com/s7ev3n/til) ä»“åº“è§¦å‘è‡ªåŠ¨åŒæ­¥

              ---
              **åˆ†æ”¯**: \`${branch}\`
              **è§¦å‘æ—¶é—´**: ${new Date().toISOString()}
              **åŒæ­¥æ¥æº**: [til@${{ steps.commit-push.outputs.sha }}](https://github.com/s7ev3n/til/commit/${{ steps.commit-push.outputs.sha }})`,
                head: branch,
                base: 'main',
                labels: ['automated', 'content-sync']
              });

              console.log('âœ… PR created:', pr.html_url);
            } else {
              console.log('â„¹ï¸ PR already exists:', pulls[0].html_url);
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Step 5: å¤±è´¥æ—¶åˆ›å»º Issue é€šçŸ¥
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sync-failed'
            });

            // å¦‚æœå·²ç»æœ‰æœªå…³é—­çš„åŒæ­¥å¤±è´¥ issueï¼Œå°±æ›´æ–°å®ƒ
            if (issues.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `### âŒ åŒæ­¥å†æ¬¡å¤±è´¥\n\n**æ—¶é—´**: ${new Date().toISOString()}\n**Workflow**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n---\nè¯·æ£€æŸ¥ workflow æ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚`
              });
            } else {
              // å¦åˆ™åˆ›å»ºæ–°çš„ issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âŒ å†…å®¹åŒæ­¥å¤±è´¥',
                body: `### åšå®¢å†…å®¹åŒæ­¥å¤±è´¥\n\n**æ—¶é—´**: ${new Date().toISOString()}\n**Commit**: ${context.sha}\n**Workflow**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n---\nè¯·æ£€æŸ¥ [workflow æ—¥å¿—](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) æ’æŸ¥é—®é¢˜ã€‚`,
                labels: ['sync-failed', 'bug']
              });
            }
